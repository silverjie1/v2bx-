#!/bin/bash

# === é¢œè‰²å®šä¹‰ ===
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
RESET='\033[0m'

# === é¢„å®šä¹‰å‚æ•° (è¯·åŠ¡å¿…æ›¿æ¢ä¸ºä½ çš„å®žé™…å€¼) ===
UserUUID="e74e2aa9-ce78-4c56-abaf-128841b810d0"            # ä½ çš„ NF Unlock ç”¨æˆ· UUIDï¼Œç”¨äºŽ NFU è„šæœ¬
CFKEY="a3f180b1491efcf9a015dd22d02b05bf3a23c"   # ä½ çš„ Cloudflare API å¯†é’¥ï¼Œç”¨äºŽæ›´æ–° DNS è®°å½•
CFUSER="zzzxxx5745@gmail.com"  # ä½ çš„ Cloudflare é‚®ç®±ï¼Œç”¨äºŽæ›´æ–° DNS è®°å½•
DNS_ZONE_1="chaoyueemail.com"      # ä½ è¦æ›´æ–°çš„ç¬¬ä¸€ä¸ª Cloudflare åŸŸå
DNS_RECORD_1="hk4"        # ä½ è¦æ›´æ–°çš„ç¬¬ä¸€ä¸ª Cloudflare DNS è®°å½•åç§° (ä¾‹å¦‚: vps)
DNS_ZONE_2="myyemail.com"      # ä½ è¦æ›´æ–°çš„ç¬¬äºŒä¸ª Cloudflare åŸŸå (å¦‚æžœéœ€è¦)
DNS_RECORD_2="hk4.ab-c789-4500-8caf-d2a37755fe09"        # ä½ è¦æ›´æ–°çš„ç¬¬äºŒä¸ª Cloudflare DNS è®°å½•åç§° (å¦‚æžœéœ€è¦)
V2BX_API_HOST="https://f.964444.xyz" # ä½ çš„ V2bX API åœ°å€
V2BX_API_KEY="OQO20TUNNFZKaT7w9yK7iE"    # ä½ çš„ V2bX API å¯†é’¥
V2BX_NODE_ID="11"         # ä½ å¸Œæœ›åœ¨ V2bX ä¸­ä½¿ç”¨çš„èŠ‚ç‚¹ ID
V2BX_NODE_TYPE="vless"              # ä½ å¸Œæœ›åœ¨ V2bX ä¸­ä½¿ç”¨çš„èŠ‚ç‚¹ç±»åž‹ (ä¾‹å¦‚: vless, trojan)
V2BX_CORE_TYPE="xray"               # ä½ å¸Œæœ› V2bX ä½¿ç”¨çš„æ ¸å¿ƒ (ä¾‹å¦‚: xray, sing-box)
V2BX_CERT_MODE="file"               # V2bX è¯ä¹¦èŽ·å–æ–¹å¼ (ä¾‹å¦‚: http, tls, none)
V2BX_CERT_DOMAIN="hk4.chaoyueemail.com" # V2bX è¯ä¹¦ç»‘å®šçš„åŸŸå
NFU_PRESET_OUT_AREA_NAME="HK Out"    # NFU é¢„è®¾å‡ºå£åœ°åŒºåç§° (å¿…é¡»ä¸Ž service-information.json ä¸­çš„ "name" å®Œå…¨åŒ¹é…)
NFU_SERVICE_INFO_URL="https://config.nfdns.xyz/service-information.json" # NFU æœåŠ¡ä¿¡æ¯ URL

# === æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ· ===
[[ $EUID -ne 0 ]] && echo -e "${RED}é”™è¯¯ï¼š${RESET} å¿…é¡»ä½¿ç”¨rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬ï¼\n" && exit 1

# === å®‰è£…ä¾èµ–å‡½æ•° ===
install_dependencies() {
    echo -e "${YELLOW}æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–...${RESET}"
    packages=("sudo" "sed" "wget" "jq" "curl" "bc")
    for pkg in "${packages[@]}"; do
        if ! command -v "$pkg" &> /dev/null; then
            echo -e "${YELLOW}æœªæ‰¾åˆ° $pkgï¼Œæ­£åœ¨å®‰è£…...${RESET}"
            if [ -x "$(command -v apt-get)" ]; then
                apt-get update
                apt-get install -y "$pkg"
            elif [ -x "$(command -v yum)" ]; then
                yum install -y "$pkg"
            else
                echo -e "${RED}é”™è¯¯ï¼š${RESET} æ— æ³•æ‰¾åˆ° apt-get æˆ– yumï¼Œè¯·æ‰‹åŠ¨å®‰è£… $pkg å¹¶é‡è¯•ã€‚"
                exit 1
            fi
        fi
    done
    echo -e "${GREEN}ä¾èµ–å®‰è£…å®Œæˆã€‚${RESET}"
}

# === èŽ·å–å…¬ç½‘ IPv4 å‡½æ•° ===
get_public_ipv4() {
  local IPV4=$(curl -s http://ipv4.icanhazip.com)
  if [[ -z "$IPV4" ]]; then
    echo -e "${RED}âŒ æ— æ³•èŽ·å–å…¬ç½‘ IPï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥ã€‚${RESET}"
    exit 1
  fi
  echo "$IPV4"
}

# === æ›´æ–° Cloudflare DNS è®°å½•å‡½æ•° ===
update_record() {
  local CFZONE_NAME=$1
  local CFRECORD_NAME=$2
  local IPV4=$3

  echo "âž¡ï¸ å¼€å§‹æ›´æ–° $CFRECORD_NAME.$CFZONE_NAME çš„ A è®°å½•..."

  # èŽ·å– Zone ID
  local ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$CFZONE_NAME" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -n 1 | cut -d'"' -f4)

  if [[ -z "$ZONE_ID" ]]; then
    echo -e "${RED}âŒ èŽ·å– Zone ID å¤±è´¥ï¼ˆ$CFZONE_NAMEï¼‰${RESET}"
    return 1
  fi

  # èŽ·å– DNS è®°å½• ID
  local RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records?name=$CFRECORD_NAME.$CFZONE_NAME&type=A" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -n 1 | cut -d'"' -f4)

  if [[ -z "$RECORD_ID" ]]; then
    echo -e "${RED}âŒ èŽ·å– DNS è®°å½• ID å¤±è´¥ï¼ˆ$CFRECORD_NAME.$CFZONE_NAMEï¼‰${RESET}"
    return 1
  fi

  # æ›´æ–° DNS è®°å½•
  local UPDATE=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" \
    --data "{\"type\":\"A\",\"name\":\"$CFRECORD_NAME.$CFZONE_NAME\",\"content\":\"$IPV4\",\"ttl\":120,\"proxied\":false}")

  if echo "$UPDATE" | grep -q '"success":true'; then
    echo -e "âœ… æˆåŠŸæ›´æ–° $CFRECORD_NAME.$CFZONE_NAME -> ${GREEN}$IPV4${RESET}"
  else
    echo -e "${RED}âŒ æ›´æ–°å¤±è´¥ï¼š$CFRECORD_NAME.$CFZONE_NAME${RESET}"
    echo "$UPDATE"
  fi
}

echo -e "${CYAN}â³ ç­‰å¾… 2 åˆ†é’Ÿä»¥ç¡®ä¿ DNS è®°å½•ç”Ÿæ•ˆ...${RESET}"
sleep 120

# === å®‰è£… V2bX å‡½æ•° ===
install_v2bx() {
    echo -e "\nðŸ“¦ å®‰è£… V2bX..."
    wget -N https://raw.githubusercontent.com/wyx2685/V2bX-script/master/install.sh
    echo -e "n" | bash install.sh
}

# === é…ç½® V2bX èŠ‚ç‚¹å‡½æ•° ===
config_v2bx() {
    echo -e "\nâš™ï¸ é…ç½® V2bX èŠ‚ç‚¹..."
    wget -N https://raw.githubusercontent.com/rebecca554owen/toys/main/sh/v2bx.sh
    bash v2bx.sh \
      LogLevel=error \
      ApiHost="$V2BX_API_HOST" \
      ApiKey="$V2BX_API_KEY" \
      NodeID="$V2BX_NODE_ID" \
      NodeType="$V2BX_NODE_TYPE" \
      CoreType="$V2BX_CORE_TYPE" \
      CertMode="$V2BX_CERT_MODE" \
      CertDomain="$V2BX_CERT_DOMAIN" \
      CF_API_EMAIL="$CFUSER" \
      CF_API_KEY="$CFKEY"
    echo -e "${GREEN}âœ… V2bX é…ç½®å®Œæˆã€‚${RESET}"
}

# === å®‰è£… NFU å‡½æ•° ===
install_nfu() {
    echo -e "\nâš™ï¸ å®‰è£… NFU ç®¡ç†è„šæœ¬..."
    mkdir -p /etc/nfu/
    if [ ! -f "/etc/nfu/config.json" ]; then
        wget -O /etc/nfu/config.json https://config.nfdns.xyz/nfu_sh/config.json
        sed -i "s/UserUUID/\"$UserUUID\"/g" /etc/nfu/config.json
        sed -i "s/OutArea/\"$NFU_PRESET_OUT_AREA_NAME\"/g" /etc/nfu/config.json
    else
        echo -e "${YELLOW}æç¤ºï¼š${RESET} æ–‡ä»¶ /etc/nfu/config.json å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½ã€‚"
    fi
    wget -O /etc/nfu/version.json https://config.nfdns.xyz/nfu_sh/version.json
    wget -O /usr/bin/nfu https://config.nfdns.xyz/nfu_sh/nfu.sh
    chmod +x /usr/bin/nfu
    NFUVersion=$(jq -r '.Version' /etc/nfu/version.json)
    echo -e "${GREEN}âœ… NFU ${NFUVersion} å®‰è£…å®Œæˆã€‚${RESET}"
}

# === é…ç½® NFU å¯¹æŽ¥ V2bX ===
config_nfu_v2bx() {
    echo -e "\nðŸ”— é…ç½® NFU å¯¹æŽ¥ V2bX..."
    # ä¸‹è½½æœåŠ¡ä¿¡æ¯æ–‡ä»¶
    wget -O /tmp/service-information.json "$NFU_SERVICE_INFO_URL"
    if [ $? -eq 0 ]; then
        # æŸ¥æ‰¾ä¸Žé¢„è®¾åç§°å®Œå…¨åŒ¹é…çš„æœåŠ¡
        local selected_service=$(jq -c ".[] | select(.name == \"$NFU_PRESET_OUT_AREA_NAME\")" /tmp/service-information.json | head -n 1)
        if [[ -n "$selected_service" ]]; then
            local selected_name=$(echo "$selected_service" | jq -r '.name')
            local selected_domain=$(echo "$selected_service" | jq -r '.domain')
            local selected_port=$(echo "$selected_service" | jq -r '.port')

            echo -e "${YELLOW}é…ç½® NFU ä½¿ç”¨å‡ºå£: ${GREEN}$selected_name (${selected_domain}:${selected_port})${RESET}"

            # æ›´æ–° /etc/nfu/config.json ä¸­çš„ OutArea
            sed -i "s/\"$NFU_PRESET_OUT_AREA_NAME\"/\"$selected_name\"/g" /etc/nfu/config.json

            # åˆ›å»ºæˆ–æ›´æ–° /etc/nfu/config_detail.json æ¥å­˜å‚¨ domain å’Œ port
            cat > /etc/nfu/config_detail.json <<EOF
{
  "domain": "$selected_domain",
  "port": "$selected_port"
}
EOF

            echo -e "${GREEN}âœ… NFU é…ç½®å·²æ›´æ–°ä¸ºä½¿ç”¨ ${selected_name}ã€‚è¯¦ç»†ä¿¡æ¯å·²ä¿å­˜åˆ° /etc/nfu/config_detail.json${RESET}"
        else
            echo -e "${YELLOW}âš ï¸ æœªåœ¨æœåŠ¡åˆ—è¡¨ä¸­æ‰¾åˆ°åç§°ä¸º \"$NFU_PRESET_OUT_AREA_NAME\" çš„å‡ºå£ï¼Œè¯·æ£€æŸ¥ ${NFU_SERVICE_INFO_URL}${RESET}"
            echo -e "${YELLOW}âš ï¸ NFU çš„å‡ºå£é…ç½®å¯èƒ½éœ€è¦æ‰‹åŠ¨è¿è¡Œ 'nfu' å‘½ä»¤åŽè¿›è¡Œè°ƒæ•´ã€‚${RESET}"
        fi
        rm -f /tmp/service-information.json
    else
        echo -e "${RED}âŒ æ— æ³•ä¸‹è½½æœåŠ¡ä¿¡æ¯æ–‡ä»¶ï¼ŒNFU çš„å‡ºå£é…ç½®å¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´ã€‚${RESET}"
    fi
}

# === ä¸»æµç¨‹ ===
echo -e "${GREEN}ðŸš€ è„šæœ¬å¼€å§‹æ‰§è¡Œ...${RESET}"

# 1. å®‰è£…ä¾èµ–
install_dependencies

# 2. æ›´æ–° Cloudflare DNS è®°å½• (ç›´æŽ¥è°ƒç”¨ get_public_ipv4)
update_record "$DNS_ZONE_1" "$DNS_RECORD_1" "$(get_public_ipv4)"
update_record "$DNS_ZONE_2" "$DNS_RECORD_2" "$(get_public_ipv4)"

# 3. å®‰è£… V2bX
install_v2bx

# 4. é…ç½® V2bX èŠ‚ç‚¹
config_v2bx

# 5. å®‰è£… NFU
install_nfu

# 6. é…ç½® NFU å¯¹æŽ¥ V2bX
config_nfu_v2bx

echo -e "\n${GREEN}ðŸŽ‰ æ‰€æœ‰æ­¥éª¤å·²å®Œæˆï¼${RESET}"
echo -e "NFU å·²é…ç½®ä¸ºä½¿ç”¨é¢„è®¾å‡ºå£ (å¦‚æžœæ‰¾åˆ°)ã€‚æ‚¨å¯ä»¥è¿è¡Œ 'nfu' å‘½ä»¤è¿›è¡Œç®¡ç†ã€‚"

exit 0
