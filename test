#!/bin/bash

set -e

# === Cloudflare DDNS è®¾ç½® ===
CFKEY="a3f180b1491efcf9a015dd22d02b05bf3a23c"
CFUSER="zzzxxx5745@gmail.com"
CFZONE_NAME="chaoyueemail.com"
CFRECORD_NAME="hk2.b01d1e-cdd6-4a11-9fb8-1c45613e3eab"

echo "ğŸŒ æ­£åœ¨è·å–å…¬ç½‘ IP..."
IPV4=$(curl -s http://ipv4.icanhazip.com)

if [[ -z "$IPV4" && -z "$IPV6" ]]; then
  echo "âŒ æ— æ³•è·å–å…¬ç½‘ IPï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"
  exit 1
fi

# === Cloudflare DDNS è®¾ç½® ===
CFKEY="a3f180b1491efcf9a015dd22d02b05bf3a23c"
CFUSER="zzzxxx5745@gmail.com"
CFZONE_NAME="myyemail.com"
CFRECORD_NAME="hk2.ab-c789-4500-8caf-d2a37755fe09"

echo "ğŸŒ æ­£åœ¨è·å–å…¬ç½‘ IP..."
IPV4=$(curl -s http://ipv4.icanhazip.com)

if [[ -z "$IPV4" && -z "$IPV6" ]]; then
  echo "âŒ æ— æ³•è·å–å…¬ç½‘ IPï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"
  exit 1
fi

echo "ğŸŒ è·å– Zone ID..."
ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$CFZONE_NAME" \
  -H "X-Auth-Email: $CFUSER" \
  -H "X-Auth-Key: $CFKEY" \
  -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -n 1 | cut -d'"' -f4)

if [[ -z "$ZONE_ID" ]]; then
  echo "âŒ è·å– Zone ID å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key å’ŒåŸŸåé…ç½®ã€‚"
  exit 1
fi

update_dns_record() {
  local RECORD_TYPE=$1
  local RECORD_NAME=$2
  local IP=$3

  local RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records?name=$RECORD_NAME.$CFZONE_NAME&type=$RECORD_TYPE" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -n 1 | cut -d'"' -f4)

  if [[ -z "$RECORD_ID" ]]; then
    echo "âŒ è·å– $RECORD_TYPE è®°å½• ID å¤±è´¥ï¼š$RECORD_NAME.$CFZONE_NAME"
    return 1
  fi

  local UPDATE_RESPONSE=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" \
    --data "{\"type\":\"$RECORD_TYPE\",\"name\":\"$RECORD_NAME.$CFZONE_NAME\",\"content\":\"$IP\",\"ttl\":120,\"proxied\":false}")

  if echo "$UPDATE_RESPONSE" | grep -q '"success":true'; then
    echo "âœ… $RECORD_TYPE è®°å½•æ›´æ–°æˆåŠŸï¼š$RECORD_NAME.$CFZONE_NAME -> $IP"
  else
    echo "âŒ $RECORD_TYPE è®°å½•æ›´æ–°å¤±è´¥ï¼š$RECORD_NAME.$CFZONE_NAME"
    echo "å“åº”ï¼š$UPDATE_RESPONSE"
  fi
}

if [[ -n "$IPV4" ]]; then
  update_dns_record "A" "$CFRECORD_NAME" "$IPV4"
  update_dns_record "A" "$CFRECORD_NAME_V6" "$IPV4"
fi

if [[ -n "$IPV6" ]]; then
  update_dns_record "AAAA" "$CFRECORD_NAME" "$IPV6"
  update_dns_record "AAAA" "$CFRECORD_NAME_V6" "$IPV6"
fi

# === å®‰è£…ä¾èµ– ===
apt update
apt install -y jq bc curl wget

# === å®‰è£… V2bX ä¸»ç¨‹åº ===
echo "ğŸ“¦ å®‰è£… V2bX..."
wget -N https://raw.githubusercontent.com/wyx2685/V2bX-script/master/install.sh && bash install.sh

# === ä¸‹è½½å¹¶è¿è¡Œ v2bx.sh è„šæœ¬ ===
echo "âš™ï¸ é…ç½® V2bX èŠ‚ç‚¹..."
wget -N https://raw.githubusercontent.com/rebecca554owen/toys/main/sh/v2bx.sh

bash v2bx.sh \
  LogLevel=error \
  ApiHost=https://f.964444.xyz \
  ApiKey=OQO20TUNNFZKaT7w9yK7iE \
  NodeID=10 \
  NodeType=vless \
  CoreType=xray \
  CertMode=http \
  CertDomain=hk2.b01d1e-cdd6-4a11-9fb8-1c45613e3eab.chaoyueemail.com

echo "âœ… éƒ¨ç½²å®Œæˆï¼Œè¯·ä½¿ç”¨ v2bx å‘½ä»¤ç®¡ç† V2bX åç«¯ã€‚"
