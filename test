#!/bin/bash

set -e

# ===== Cloudflare DDNS 更新部分 =====
CF_API_TOKEN="a3f180b1491efcf9a015dd22d02b05bf3a23c"

DOMAINS=(
  "hk2.b01d1e-cdd6-4a11-9fb8-1c45613e3eab.chaoyueemail.com"
  "hk2.ab-c789-4500-8caf-d2a37755fe09.myyemail.com"
)

echo "🔍 获取当前公网 IP..."
CURRENT_IP=$(curl -s https://api.ipify.org)
echo "当前 IP: $CURRENT_IP"

update_cf_record() {
  local domain=$1
  echo "🌐 正在处理域名: $domain"

  zone_name=$(echo "$domain" | awk -F. '{print $(NF-2)"."$(NF-1)"."$NF}')
  echo "📦 顶级域名: $zone_name"

  echo "🔑 获取 Zone ID..."
  zone_id=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=${zone_name}" \
    -H "Authorization: Bearer ${CF_API_TOKEN}" \
    -H "Content-Type: application/json" | jq -r '.result[0].id')

  echo "🧹 Zone ID: $zone_id"

  echo "🔎 获取 DNS Record ID..."
  record_info=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records?name=${domain}" \
    -H "Authorization: Bearer ${CF_API_TOKEN}" \
    -H "Content-Type: application/json")

  record_id=$(echo "$record_info" | jq -r '.result[0].id')
  record_ip=$(echo "$record_info" | jq -r '.result[0].content')

  echo "🎯 当前记录 IP: $record_ip"

  if [ "$CURRENT_IP" != "$record_ip" ]; then
    echo "🛠 IP 不一致，更新中..."
    curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records/${record_id}" \
      -H "Authorization: Bearer ${CF_API_TOKEN}" \
      -H "Content-Type: application/json" \
      --data "{\"type\":\"A\",\"name\":\"${domain}\",\"content\":\"${CURRENT_IP}\",\"ttl\":120,\"proxied\":false}" > /dev/null
    echo "✅ 域名 ${domain} 已更新为 IP: $CURRENT_IP"
  else
    echo "✅ 域名 ${domain} 的 IP 无需更新"
  fi
}

# 遍历所有域名进行更新
for domain in "${DOMAINS[@]}"; do
  update_cf_record "$domain"
done

# ===== 安装依赖和拉取其他脚本 =====
echo "📦 安装依赖..."
apt update && apt install -y jq wget curl

echo "📅 拉取并运行 V2bX 安装脚本..."
wget -N https://raw.githubusercontent.com/wyx2685/V2bX-script/master/install.sh
bash install.sh

echo "📅 拉取 v2bx.sh..."
wget -N https://raw.githubusercontent.com/rebecca554owen/toys/main/sh/v2bx.sh
chmod +x v2bx.sh

echo "🚀 执行 v2bx.sh 配置脚本..."
bash v2bx.sh \
    LogLevel=error \
    ApiHost=https://f.964444.xyz \
    ApiKey=OQO20TUNNFZKaT7w9yK7iE \
    NodeID=10 \
    NodeType=vless \
    CoreType=xray \
    CertMode=http \
    CertDomain=hk2.b01d1e-cdd6-4a11-9fb8-1c45613e3eab.chaoyueemail.com

echo "🎉 所有流程执行完毕 ✅"
