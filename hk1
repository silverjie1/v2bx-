#!/bin/bash

# === é¢œè‰²å®šä¹‰ ===
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
RESET='\033[0m'

# === é¢„å®šä¹‰å‚æ•° (è¯·åŠ¡å¿…æ›¿æ¢ä¸ºä½ çš„å®é™…å€¼) ===
UserUUID="e74e2aa9-ce78-4c56-abaf-128841b810d0"            # ä½ çš„ NF Unlock ç”¨æˆ· UUIDï¼Œç”¨äº NFU è„šæœ¬
CFKEY="a3f180b1491efcf9a015dd22d02b05bf3a23c"   # ä½ çš„ Cloudflare API å¯†é’¥ï¼Œç”¨äºæ›´æ–° DNS è®°å½•
CFUSER="zzzxxx5745@gmail.com"  # ä½ çš„ Cloudflare é‚®ç®±ï¼Œç”¨äºæ›´æ–° DNS è®°å½•
DNS_ZONE_1="chaoyueemail.com"      # ä½ è¦æ›´æ–°çš„ç¬¬ä¸€ä¸ª Cloudflare åŸŸå
DNS_RECORD_1="hk1"        # ä½ è¦æ›´æ–°çš„ç¬¬ä¸€ä¸ª Cloudflare DNS è®°å½•åç§° (ä¾‹å¦‚: vps)
DNS_ZONE_2="myyemail.com"      # ä½ è¦æ›´æ–°çš„ç¬¬äºŒä¸ª Cloudflare åŸŸå (å¦‚æœéœ€è¦)
DNS_RECORD_2="hk1.ab-c789-4500-8caf-d2a37755fe09"        # ä½ è¦æ›´æ–°çš„ç¬¬äºŒä¸ª Cloudflare DNS è®°å½•åç§° (å¦‚æœéœ€è¦)
V2BX_API_HOST="https://f.964444.xyz" # ä½ çš„ V2bX API åœ°å€
V2BX_API_KEY="OQO20TUNNFZKaT7w9yK7iE"    # ä½ çš„ V2bX API å¯†é’¥
V2BX_NODE_ID="7"         # ä½ å¸Œæœ›åœ¨ V2bX ä¸­ä½¿ç”¨çš„èŠ‚ç‚¹ ID
V2BX_NODE_TYPE="vless"              # ä½ å¸Œæœ›åœ¨ V2bX ä¸­ä½¿ç”¨çš„èŠ‚ç‚¹ç±»å‹ (ä¾‹å¦‚: vless, trojan)
V2BX_CORE_TYPE="xray"               # ä½ å¸Œæœ› V2bX ä½¿ç”¨çš„æ ¸å¿ƒ (ä¾‹å¦‚: xray, sing-box)
V2BX_CERT_MODE="file"               # V2bX è¯ä¹¦è·å–æ–¹å¼ (ä¾‹å¦‚: http, tls, none)
V2BX_CERT_DOMAIN="hk1.chaoyueemail.com" # V2bX è¯ä¹¦ç»‘å®šçš„åŸŸå
NFU_PRESET_OUT_AREA_NAME="HK Out"    # NFU é¢„è®¾å‡ºå£åœ°åŒºåç§° (å¿…é¡»ä¸ service-information.json ä¸­çš„ "name" å®Œå…¨åŒ¹é…)
NFU_SERVICE_INFO_URL="https://config.nfdns.xyz/service-information.json" # NFU æœåŠ¡ä¿¡æ¯ URL
CUSTOM_OUTBOUND_CONFIG_URL="https://config.nfdns.xyz/nfu_sh/config/xrayr/custom_outbound.json"
ROUTE_CONFIG_URL="https://config.nfdns.xyz/nfu_sh/config/xrayr/route.json"
V2BX_CONFIG_DIR="/etc/V2bX"
CUSTOM_OUTBOUND_CONFIG_FILE="$V2BX_CONFIG_DIR/custom_outbound.json"
ROUTE_CONFIG_FILE="$V2BX_CONFIG_DIR/route.json"

# === æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ· ===
[[ $EUID -ne 0 ]] && echo -e "${RED}é”™è¯¯ï¼š${RESET} å¿…é¡»ä½¿ç”¨rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬ï¼\n" && exit 1

# === å®‰è£…ä¾èµ–å‡½æ•° ===
install_dependencies() {
    echo -e "${YELLOW}æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–...${RESET}"
    packages=("sudo" "sed" "wget" "curl" "bc" "awk")
    for pkg in "${packages[@]}"; do
        if ! command -v "$pkg" &> /dev/null; then
            echo -e "${YELLOW}æœªæ‰¾åˆ° $pkgï¼Œæ­£åœ¨å®‰è£…...${RESET}"
            if [ -x "$(command -v apt-get)" ]; then
                apt-get update
                apt-get install -y "$pkg"
            elif [ -x "$(command -v yum)" ]; then
                yum install -y "$pkg"
            else
                echo -e "${RED}é”™è¯¯ï¼š${RESET} æ— æ³•æ‰¾åˆ° apt-get æˆ– yumï¼Œè¯·æ‰‹åŠ¨å®‰è£… $pkg å¹¶é‡è¯•ã€‚"
                exit 1
            fi
        fi
    done
    echo -e "${GREEN}ä¾èµ–å®‰è£…å®Œæˆã€‚${RESET}"
}

# === è·å–å…¬ç½‘ IPv4 å‡½æ•° ===
get_public_ipv4() {
  local IPV4=$(curl -s http://ipv4.icanhazip.com)
  if [[ -z "$IPV4" ]]; then
    echo -e "${RED}âŒ æ— æ³•è·å–å…¬ç½‘ IPï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚${RESET}"
    exit 1
  fi
  echo "$IPV4"
}

# === æ›´æ–° Cloudflare DNS è®°å½•å‡½æ•° ===
update_record() {
  local CFZONE_NAME=$1
  local CFRECORD_NAME=$2
  local IPV4=$3

  echo "â¡ï¸ å¼€å§‹æ›´æ–° $CFRECORD_NAME.$CFZONE_NAME çš„ A è®°å½•..."

  # è·å– Zone ID
  local ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$CFZONE_NAME" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -n 1 | cut -d'"' -f4)

  if [[ -z "$ZONE_ID" ]]; then
    echo -e "${RED}âŒ è·å– Zone ID å¤±è´¥ï¼ˆ$CFZONE_NAMEï¼‰${RESET}"
    return 1
  fi

  # è·å– DNS è®°å½• ID
  local RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records?name=$CFRECORD_NAME.$CFZONE_NAME&type=A" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -n 1 | cut -d'"' -f4)

  if [[ -z "$RECORD_ID" ]]; then
    echo -e "${RED}âŒ è·å– DNS è®°å½• ID å¤±è´¥ï¼ˆ$CFRECORD_NAME.$CFZONE_NAMEï¼‰${RESET}"
    return 1
  fi

  # æ›´æ–° DNS è®°å½•
  local UPDATE=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" \
    --data "{\"type\":\"A\",\"name\":\"$CFRECORD_NAME.$CFZONE_NAME\",\"content\":\"$IPV4\",\"ttl\":120,\"proxied\":false}")

  if echo "$UPDATE" | grep -q '"success":true'; then
    echo -e "âœ… æˆåŠŸæ›´æ–° $CFRECORD_NAME.$CFZONE_NAME -> ${GREEN}$IPV4${RESET}"
  else
    echo -e "${RED}âŒ æ›´æ–°å¤±è´¥ï¼š$CFRECORD_NAME.$CFZONE_NAME${RESET}"
    echo "$UPDATE"
  fi
}

# === å®‰è£… V2bX å‡½æ•° ===
install_v2bx() {
    echo -e "\nğŸ“¦ å®‰è£… V2bX..."
    wget -N https://raw.githubusercontent.com/wyx2685/V2bX-script/master/install.sh
    echo -e "n" | bash install.sh
}

echo -e "\nğŸ” æ­£åœ¨æ‹‰å– TLS è¯ä¹¦..."

CERT_DIR="/etc/V2bX"
CERT_URL="https://raw.githubusercontent.com/silverjie1/v2bx-/refs/heads/main/cert.pem"
KEY_URL="https://raw.githubusercontent.com/silverjie1/v2bx-/refs/heads/main/key.pem"

mkdir -p "$CERT_DIR"

# ä¸‹è½½è¯ä¹¦
curl -fsSL -o "$CERT_DIR/fullchain.cer" "$CERT_URL"
curl -fsSL -o "$CERT_DIR/cert.key" "$KEY_URL"

# æ ¡éªŒä¸‹è½½ç»“æœ
if [[ -f "$CERT_DIR/fullchain.cer" && -f "$CERT_DIR/cert.key" ]]; then
  echo -e "âœ… TLS è¯ä¹¦ä¸‹è½½å®Œæˆï¼Œä¿å­˜è‡³ $CERT_DIR"
else
  echo -e "âŒ è¯ä¹¦ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ GitHub åœ°å€æˆ–ç½‘ç»œè¿æ¥"
  exit 1
fi

# === é…ç½® V2bX èŠ‚ç‚¹å‡½æ•° ===
config_v2bx() {
    echo -e "\nâš™ï¸ é…ç½® V2bX èŠ‚ç‚¹..."
    wget -N https://raw.githubusercontent.com/rebecca554owen/toys/main/sh/v2bx.sh
    bash v2bx.sh \
      LogLevel=error \
      ApiHost="$V2BX_API_HOST" \
      ApiKey="$V2BX_API_KEY" \
      NodeID="$V2BX_NODE_ID" \
      NodeType="$V2BX_NODE_TYPE" \
      CoreType="$V2BX_CORE_TYPE" \
      CertMode="$V2BX_CERT_MODE" \
      CertDomain="$V2BX_CERT_DOMAIN" \
      CF_API_EMAIL="$CFUSER" \
      CF_API_KEY="$CFKEY"
    echo -e "${GREEN}âœ… V2bX é…ç½®å®Œæˆã€‚${RESET}"
}

# === é…ç½® V2bX å‡ºå£å’Œè·¯ç”± (ä½¿ç”¨ awk å¤„ç† JSON) ===
config_v2bx_outbound_route() {
    echo -e "\nâš™ï¸ é…ç½® V2bX å‡ºå£å’Œè·¯ç”± (ä½¿ç”¨ awk å¤„ç† JSON)...${RESET}"

    # ä¸‹è½½ service-information.json
    echo -e "${YELLOW}â¬‡ï¸ ä¸‹è½½ service-information.json...${RESET}"
    local service_info=$(curl -s "$SERVICE_INFO_URL")
    local service_info_status=$?

    if [ $service_info_status -eq 0 ]; then
        # æŸ¥æ‰¾é¢„è®¾å‡ºå£ä¿¡æ¯ (ä½¿ç”¨ awk)
        local outbound_address=$(echo "$service_info" | awk -F'"' -v target="$PRESET_OUT_AREA_NAME" '$2 == "name" && $4 == target {getline; if ($2 == "domain") print $4}')
        local outbound_port=$(echo "$service_info" | awk -F'"' -v target="$PRESET_OUT_AREA_NAME" '$2 == "name" && $4 == target {getline; getline; if ($2 == "port") print $4}')

        if [[ -n "$outbound_address" && -n "$outbound_port" ]]; then
            echo "æ‰¾åˆ°é¢„è®¾å‡ºå£: åœ°å€=$outbound_address, ç«¯å£=$outbound_port"

            # ä¸‹è½½ custom_outbound.json
            echo -e "${YELLOW}â¬‡ï¸ ä¸‹è½½ custom_outbound.json...${RESET}"
            local custom_outbound_config=$(curl -s "$CUSTOM_OUTBOUND_CONFIG_URL")
            local custom_outbound_status=$?

            if [ $custom_outbound_status -eq 0 ]; then
                echo -e "${YELLOW}ğŸ”„ é…ç½® custom_outbound.json...${RESET}"

                # ä½¿ç”¨ awk æ›¿æ¢ "unlock" éƒ¨åˆ†çš„ address å’Œ portï¼Œä»¥åŠæ›¿æ¢ UUID
                local updated_custom_outbound=$(echo "$custom_outbound_config" | \
                    awk -v addr="$outbound_address" -v port="$outbound_port" -v uuid="$UserUUID" '
                    {
                        gsub(/{Out}/, addr)
                        gsub(/{OutPort}/, port)
                        gsub(/{UUID}/, uuid)
                        print
                    }
                    ')

                local awk_status=$?
                echo "awk çŠ¶æ€ç : $awk_status"

                if [ $awk_status -eq 0 ]; then
                    echo -e "${YELLOW}ğŸ’¾ å†™å…¥ $CUSTOM_OUTBOUND_CONFIG_FILE ...${RESET}"
                    echo "$updated_custom_outbound" | sudo tee "$CUSTOM_OUTBOUND_CONFIG_FILE" > /dev/null
                    local write_status=$?
                    if [ $write_status -eq 0 ]; then
                        echo -e "${GREEN}âœ… custom_outbound.json é…ç½®å®Œæˆã€‚${RESET}"
                    else
                        echo -e "${RED}âŒ å†™å…¥ $CUSTOM_OUTBOUND_CONFIG_FILE å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–æ–‡ä»¶è·¯å¾„ã€‚${RESET}"
                    fi
                else
                    echo -e "${RED}âŒ awk å¤„ç† custom_outbound.json å¤±è´¥ã€‚${RESET}"
                fi
            else
                echo -e "${RED}âŒ ä¸‹è½½ custom_outbound.json å¤±è´¥ï¼Œè¯·æ£€æŸ¥ URLã€‚${RESET}"
            fi
        else
            echo -e "${YELLOW}âš ï¸ æœªåœ¨ service-information.json ä¸­æ‰¾åˆ°åç§°ä¸º \"$PRESET_OUT_AREA_NAME\" çš„å‡ºå£ã€‚${RESET}"
        fi
    else
        echo -e "${RED}âŒ ä¸‹è½½ service-information.json å¤±è´¥ï¼Œæ— æ³•é…ç½® V2bX å‡ºå£ã€‚${RESET}"
    fi

    # ä¸‹è½½ route.json å¹¶è¦†ç›–
    echo -e "${YELLOW}â¬‡ï¸ ä¸‹è½½ route.json å¹¶è¦†ç›–...${RESET}"
    curl -s "$ROUTE_CONFIG_URL" | sudo tee "$ROUTE_CONFIG_FILE" > /dev/null
    local route_download_status=$?
    echo "route.json ä¸‹è½½çŠ¶æ€ç : $route_download_status"
    if [ $route_download_status -eq 0 ]; then
        echo -e "${GREEN}âœ… route.json é…ç½®å®Œæˆã€‚${RESET}"
    else
        echo -e "${RED}âŒ ä¸‹è½½æˆ–å†™å…¥ $ROUTE_CONFIG_FILE å¤±è´¥ï¼Œè¯·æ£€æŸ¥ URL æˆ–æƒé™ã€‚${RESET}"
    fi

    # å¯ä»¥é€‰æ‹©åœ¨è¿™é‡Œé‡å¯ V2bX æœåŠ¡ï¼Œå¦‚æœéœ€è¦ç«‹å³ç”Ÿæ•ˆ
    if command -v v2bx >/dev/null 2>&1; then
        sudo v2bx restart
        echo -e "${GREEN}âœ… V2bX æœåŠ¡å·²é‡å¯ä»¥åº”ç”¨é…ç½®ã€‚${RESET}"
    fi
}

# === ä¸»æµç¨‹ ===
echo -e "${GREEN}ğŸš€ è„šæœ¬å¼€å§‹æ‰§è¡Œ...${RESET}"

# 1. å®‰è£…ä¾èµ–
install_dependencies

# 2. æ›´æ–° Cloudflare DNS è®°å½• (ç›´æ¥è°ƒç”¨ get_public_ipv4)
update_record "$DNS_ZONE_1" "$DNS_RECORD_1" "$(get_public_ipv4)"
update_record "$DNS_ZONE_2" "$DNS_RECORD_2" "$(get_public_ipv4)"

# 3. å®‰è£… V2bX
install_v2bx

# 4. é…ç½® V2bX èŠ‚ç‚¹
config_v2bx

# 5. é…ç½® V2bX å‡ºå£å’Œè·¯ç”± (ä½¿ç”¨ awk å¤„ç† JSON)
config_v2bx_outbound_route

echo -e "\n${GREEN}ğŸ‰ æ‰€æœ‰æ­¥éª¤å·²å®Œæˆï¼${RESET}"
echo -e "V2bX å·²å®‰è£…å¹¶é…ç½®å‡ºå£å’Œè·¯ç”±ã€‚"

exit 0
