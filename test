#!/bin/bash

# å…¬å…±è®¾ç½®
CFKEY="a3f180b1491efcf9a015dd22d02b05bf3a23c"
CFUSER="zzzxxx5745@gmail.com"

# è·å–å…¬ç½‘ IPv4
echo "ğŸŒ æ­£åœ¨è·å–å…¬ç½‘ IP..."
IPV4=$(curl -s http://ipv4.icanhazip.com)

if [[ -z "$IPV4" ]]; then
  echo "âŒ æ— æ³•è·å–å…¬ç½‘ IPï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"
  exit 1
fi

# æ›´æ–°è®°å½•å‡½æ•°
update_record() {
  local CFZONE_NAME=$1
  local CFRECORD_NAME=$2

  echo "â¡ï¸ å¼€å§‹æ›´æ–° $CFRECORD_NAME.$CFZONE_NAME çš„ A è®°å½•..."

  # è·å– Zone ID
  ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$CFZONE_NAME" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -n 1 | cut -d'"' -f4)

  if [[ -z "$ZONE_ID" ]]; then
    echo "âŒ è·å– Zone ID å¤±è´¥ï¼ˆ$CFZONE_NAMEï¼‰"
    return 1
  fi

  # è·å– DNS è®°å½• ID
  RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records?name=$CFRECORD_NAME.$CFZONE_NAME&type=A" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" | grep -o '"id":"[^"]*"' | head -n 1 | cut -d'"' -f4)

  if [[ -z "$RECORD_ID" ]]; then
    echo "âŒ è·å– DNS è®°å½• ID å¤±è´¥ï¼ˆ$CFRECORD_NAME.$CFZONE_NAMEï¼‰"
    return 1
  fi

  # æ›´æ–° DNS è®°å½•
  UPDATE=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID" \
    -H "X-Auth-Email: $CFUSER" \
    -H "X-Auth-Key: $CFKEY" \
    -H "Content-Type: application/json" \
    --data "{\"type\":\"A\",\"name\":\"$CFRECORD_NAME.$CFZONE_NAME\",\"content\":\"$IPV4\",\"ttl\":120,\"proxied\":false}")

  if echo "$UPDATE" | grep -q '"success":true'; then
    echo "âœ… æˆåŠŸæ›´æ–° $CFRECORD_NAME.$CFZONE_NAME -> $IPV4"
  else
    echo "âŒ æ›´æ–°å¤±è´¥ï¼š$CFRECORD_NAME.$CFZONE_NAME"
    echo "$UPDATE"
  fi
}

# === å¤šä¸ªåŸŸåè°ƒç”¨ ===
update_record "chaoyueemail.com" "hk2.b01d1e-cdd6-4a11-9fb8-1c45613e3eab"
update_record "myyemail.com" "hk2.ab-c789-4500-8caf-d2a37755fe09"


# === å®‰è£…ä¾èµ– ===
apt update
apt install -y jq bc curl wget

# === å®‰è£… V2bX ä¸»ç¨‹åº ===
echo "ğŸ“¦ å®‰è£… V2bX..."
wget -N https://raw.githubusercontent.com/wyx2685/V2bX-script/master/install.sh && bash install.sh

# === ä¸‹è½½å¹¶è¿è¡Œ v2bx.sh è„šæœ¬ ===
echo "âš™ï¸ é…ç½® V2bX èŠ‚ç‚¹..."
wget -N https://raw.githubusercontent.com/rebecca554owen/toys/main/sh/v2bx.sh

bash v2bx.sh \
  LogLevel=error \
  ApiHost=https://f.964444.xyz \
  ApiKey=OQO20TUNNFZKaT7w9yK7iE \
  NodeID=10 \
  NodeType=vless \
  CoreType=xray \
  CertMode=http \
  CertDomain=hk2.b01d1e-cdd6-4a11-9fb8-1c45613e3eab.chaoyueemail.com

echo "âœ… éƒ¨ç½²å®Œæˆï¼Œè¯·ä½¿ç”¨ v2bx å‘½ä»¤ç®¡ç† V2bX åç«¯ã€‚"
