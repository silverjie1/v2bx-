#!/bin/bash

set -e

# ===== Cloudflare DDNS æ›´æ–°éƒ¨åˆ† =====
CF_API_TOKEN="a3f180b1491efcf9a015dd22d02b05bf3a23c"

DOMAINS=(
  "hk2.b01d1e-cdd6-4a11-9fb8-1c45613e3eab.chaoyueemail.com"
  "hk2.ab-c789-4500-8caf-d2a37755fe09.myyemail.com"
)

echo "ğŸ” è·å–å½“å‰å…¬ç½‘ IP..."
CURRENT_IP=$(curl -s https://api.ipify.org)
echo "å½“å‰ IP: $CURRENT_IP"

update_cf_record() {
  local domain=$1
  echo "ğŸŒ æ­£åœ¨å¤„ç†åŸŸå: $domain"

  zone_name=$(echo "$domain" | awk -F. '{print $(NF-2)"."$(NF-1)"."$NF}')
  echo "ğŸ“¦ é¡¶çº§åŸŸå: $zone_name"

  echo "ğŸ”‘ è·å– Zone ID..."
  zone_id=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=${zone_name}" \
    -H "Authorization: Bearer ${CF_API_TOKEN}" \
    -H "Content-Type: application/json" | jq -r '.result[0].id')

  echo "ğŸ§¹ Zone ID: $zone_id"

  echo "ğŸ” è·å– DNS Record ID..."
  record_info=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records?name=${domain}" \
    -H "Authorization: Bearer ${CF_API_TOKEN}" \
    -H "Content-Type: application/json")

  record_id=$(echo "$record_info" | jq -r '.result[0].id')
  record_ip=$(echo "$record_info" | jq -r '.result[0].content')

  echo "ğŸ¯ å½“å‰è®°å½• IP: $record_ip"

  if [ "$CURRENT_IP" != "$record_ip" ]; then
    echo "ğŸ›  IP ä¸ä¸€è‡´ï¼Œæ›´æ–°ä¸­..."
    curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records/${record_id}" \
      -H "Authorization: Bearer ${CF_API_TOKEN}" \
      -H "Content-Type: application/json" \
      --data "{\"type\":\"A\",\"name\":\"${domain}\",\"content\":\"${CURRENT_IP}\",\"ttl\":120,\"proxied\":false}" > /dev/null
    echo "âœ… åŸŸå ${domain} å·²æ›´æ–°ä¸º IP: $CURRENT_IP"
  else
    echo "âœ… åŸŸå ${domain} çš„ IP æ— éœ€æ›´æ–°"
  fi
}

# éå†æ‰€æœ‰åŸŸåè¿›è¡Œæ›´æ–°
for domain in "${DOMAINS[@]}"; do
  update_cf_record "$domain"
done

# ===== å®‰è£…ä¾èµ–å’Œæ‹‰å–å…¶ä»–è„šæœ¬ =====
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
apt update && apt install -y jq wget curl

echo "ğŸ“… æ‹‰å–å¹¶è¿è¡Œ V2bX å®‰è£…è„šæœ¬..."
wget -N https://raw.githubusercontent.com/wyx2685/V2bX-script/master/install.sh
bash install.sh

echo "ğŸ“… æ‹‰å– v2bx.sh..."
wget -N https://raw.githubusercontent.com/rebecca554owen/toys/main/sh/v2bx.sh
chmod +x v2bx.sh

echo "ğŸš€ æ‰§è¡Œ v2bx.sh é…ç½®è„šæœ¬..."
bash v2bx.sh \
    LogLevel=error \
    ApiHost=https://f.964444.xyz \
    ApiKey=OQO20TUNNFZKaT7w9yK7iE \
    NodeID=10 \
    NodeType=vless \
    CoreType=xray \
    CertMode=http \
    CertDomain=hk2.b01d1e-cdd6-4a11-9fb8-1c45613e3eab.chaoyueemail.com

echo "ğŸ‰ æ‰€æœ‰æµç¨‹æ‰§è¡Œå®Œæ¯• âœ…"
